============================= test session starts =============================
platform win32 -- Python 3.11.9, pytest-9.0.2, pluggy-1.6.0 -- C:\Users\ryann\AppData\Local\Microsoft\WindowsApps\PythonSoftwareFoundation.Python.3.11_qbz5n2kfra8p0\python.exe
cachedir: .pytest_cache
rootdir: C:\Users\ryann\OneDrive\Desktop\projects\deerhacks\backend
plugins: anyio-4.9.0, langsmith-0.6.9
collecting ... collected 7 items

tests/test_commander.py::test_commander_node_success PASSED              [ 14%]
tests/test_commander.py::test_commander_node_fallback_on_error PASSED    [ 28%]
tests/test_critic.py::test_critic_node_veto FAILED                       [ 42%]
tests/test_critic.py::test_critic_node_no_candidates PASSED              [ 57%]
tests/test_snowflake.py::test_snowflake_connection PASSED                [ 71%]
tests/test_snowflake.py::test_log_risk PASSED                            [ 85%]
tests/test_snowflake.py::test_cortex_search PASSED                       [100%]

================================== FAILURES ===================================
____________________________ test_critic_node_veto ____________________________

mock_get_weather = <AsyncMock name='get_weather' id='2928858051408'>
mock_get_events = <AsyncMock name='get_events' id='2928858049040'>
mock_generate_content = <AsyncMock name='generate_content' id='2928858042704'>

    @patch('app.agents.critic.generate_content', new_callable=AsyncMock)
    @patch('app.agents.critic.get_events', new_callable=AsyncMock)
    @patch('app.agents.critic.get_weather', new_callable=AsyncMock)
    def test_critic_node_veto(mock_get_weather, mock_get_events, mock_generate_content):
        # Mock services
        mock_get_weather.return_value = {"condition": "Rain"}
        mock_get_events.return_value = [{"title": "Marathon"}]
    
        # Mock Gemini telling us it's a veto
        mock_generate_content.return_value = '''
        {
            "risks": [
                {"type": "weather", "severity": "high", "detail": "Rain"}
            ],
            "veto": true,
            "veto_reason": "Too rainy for an outdoor event."
        }
        '''
    
        state: PathfinderState = {
            "parsed_intent": {"activity": "picnic"},
            "candidate_venues": [
                {"venue_id": "v1", "name": "Park A", "lat": 43.0, "lng": -79.0}
            ]
        }
    
>       new_state = critic_node(state)
                    ^^^^^^^^^^^^^^^^^^

tests\test_critic.py:31: 
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
app\agents\critic.py:103: in critic_node
    loop = asyncio.get_event_loop()
           ^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _

self = <asyncio.windows_events.WindowsProactorEventLoopPolicy object at 0x000002A9ED8B0BD0>

    def get_event_loop(self):
        """Get the event loop for the current context.
    
        Returns an instance of EventLoop or raises an exception.
        """
        if (self._local._loop is None and
                not self._local._set_called and
                threading.current_thread() is threading.main_thread()):
            self.set_event_loop(self.new_event_loop())
    
        if self._local._loop is None:
>           raise RuntimeError('There is no current event loop in thread %r.'
                               % threading.current_thread().name)
E           RuntimeError: There is no current event loop in thread 'MainThread'.

C:\Program Files\WindowsApps\PythonSoftwareFoundation.Python.3.11_3.11.2544.0_x64__qbz5n2kfra8p0\Lib\asyncio\events.py:681: RuntimeError
============================== warnings summary ===============================
app\core\config.py:9
  C:\Users\ryann\OneDrive\Desktop\projects\deerhacks\backend\app\core\config.py:9: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class Settings(BaseSettings):

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ===========================
FAILED tests/test_critic.py::test_critic_node_veto - RuntimeError: There is n...
=================== 1 failed, 6 passed, 1 warning in 0.95s ====================
